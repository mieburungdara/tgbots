{
  "class_name": "SaleRepository",
  "table": "sales",
  "summary": "Mengelola data transaksi penjualan.",
  "description": "Repositori ini bertanggung jawab untuk mencatat setiap transaksi penjualan yang berhasil. Ia juga menyediakan metode untuk memeriksa riwayat pembelian seorang pengguna.",
  "methods": [
    {
      "name": "__construct",
      "description": "Menginisialisasi repositori dengan koneksi PDO.",
      "parameters": [
        {
          "name": "pdo",
          "type": "PDO",
          "description": "Objek koneksi database."
        }
      ]
    },
    {
      "name": "hasUserPurchased",
      "description": "Memeriksa apakah seorang pengguna sudah pernah membeli sebuah paket.",
      "parameters": [
        {
          "name": "package_id",
          "type": "int",
          "description": "ID internal paket."
        },
        {
          "name": "user_id",
          "type": "int",
          "description": "ID internal pengguna."
        }
      ],
      "logic": "`SELECT id FROM sales WHERE package_id = ? AND buyer_user_id = ?`",
      "returns": "bool",
      "return_description": "`true` jika catatan penjualan ditemukan, jika tidak `false`."
    },
    {
      "name": "createSale",
      "description": "Membuat catatan penjualan baru dan memperbarui saldo pembeli/penjual. Harus dijalankan di dalam transaksi. Dapat menyertakan tanggal kadaluarsa untuk hadiah.",
      "parameters": [
        {
          "name": "package_id",
          "type": "int",
          "description": "ID paket yang terjual."
        },
        {
          "name": "seller_user_id",
          "type": "int",
          "description": "ID pengguna penjual."
        },
        {
          "name": "buyer_user_id",
          "type": "int",
          "description": "ID pengguna pembeli."
        },
        {
          "name": "granted_to_user_id",
          "type": "int",
          "description": "ID pengguna yang menerima akses konten (jika berbeda dari pembeli, misal untuk hadiah)."
        },
        {
          "name": "price",
          "type": "float",
          "description": "Harga pada saat penjualan."
        },
        {
          "name": "expires_at",
          "type": "string",
          "description": "Tanggal dan waktu kadaluarsa hadiah (opsional, format Y-m-d H:i:s).",
          "nullable": true
        }
      ],
      "logic": "Melakukan UPDATE pada saldo penjual dan pembeli, lalu INSERT ke tabel sales.",
      "returns": "bool"
    },
    {
      "name": "findPackagesByBuyerId",
      "description": "Menemukan semua paket yang telah dibeli oleh seorang pengguna.",
      "parameters": [
        {
          "name": "buyer_user_id",
          "type": "int",
          "description": "ID internal pengguna."
        }
      ],
      "logic": "`SELECT s.purchased_at, mp.* FROM sales s JOIN media_packages mp ON s.package_id = mp.id WHERE s.buyer_user_id = ?`",
      "returns": "array"
    },
    {
      "name": "countSalesForPackage",
      "description": "Menghitung jumlah penjualan untuk sebuah paket spesifik.",
      "params": [
        {
          "name": "package_id",
          "type": "int"
        }
      ],
      "return": {
        "type": "int"
      }
    },
    {
      "name": "createSubscriptionSale",
      "description": "Membuat catatan transaksi untuk penjualan langganan, yang tidak terikat pada satu paket.",
      "params": [
        {
          "name": "seller_user_id",
          "type": "int"
        },
        {
          "name": "buyer_user_id",
          "type": "int"
        },
        {
          "name": "price",
          "type": "float"
        }
      ],
      "return": {
        "type": "bool"
      }
    },
    {
      "name": "getSaleDetails",
      "description": "Mendapatkan detail penjualan berdasarkan package_id dan granted_to_user_id. Digunakan untuk memeriksa status hadiah.",
      "parameters": [
        {
          "name": "package_id",
          "type": "int",
          "description": "ID internal paket."
        },
        {
          "name": "granted_to_user_id",
          "type": "int",
          "description": "ID pengguna yang diberikan akses."
        }
      ],
      "returns": "array|false"
    },
    {
      "name": "markSaleAsClaimed",
      "description": "Menandai hadiah sebagai sudah diklaim.",
      "parameters": [
        {
          "name": "sale_id",
          "type": "int",
          "description": "ID penjualan."
        }
      ],
      "returns": "bool"
    },
    {
      "name": "findExpiringUnclaimedGifts",
      "description": "Menemukan hadiah yang akan kadaluarsa dan belum diklaim.",
      "parameters": [
        {
          "name": "hours_until_expiration",
          "type": "int",
          "description": "Batas waktu dalam jam."
        }
      ],
      "returns": "array"
    },
    {
      "name": "cancelGiftSale",
      "description": "Membatalkan penjualan hadiah dan mengembalikan saldo pembeli.",
      "parameters": [
        {
          "name": "sale_id",
          "type": "int",
          "description": "ID penjualan hadiah."
        },
        {
          "name": "buyer_user_id",
          "type": "int",
          "description": "ID pembeli (pengirim hadiah)."
        },
        {
          "name": "price",
          "type": "float",
          "description": "Harga hadiah yang akan dikembalikan."
        }
      ],
      "returns": "bool"
    },
    {
      "name": "getSaleDetailsById",
      "description": "Mendapatkan detail penjualan berdasarkan ID penjualan.",
      "parameters": [
        {
          "name": "sale_id",
          "type": "int",
          "description": "ID penjualan."
        }
      ],
      "returns": "array|false"
    },
    {
      "name": "reGiftSale",
      "description": "Menghadiahkan ulang sebuah penjualan hadiah kepada pengguna baru.",
      "parameters": [
        {
          "name": "sale_id",
          "type": "int",
          "description": "ID penjualan hadiah yang akan dihadiahkan ulang."
        },
        {
          "name": "new_granted_to_user_id",
          "type": "int",
          "description": "ID pengguna baru yang akan menerima hadiah."
        }
      ],
      "returns": "bool"
    }
  ]
}
