{
  "flow_name": "/sell",
  "summary": "Memulai alur penjualan interaktif untuk satu atau banyak media.",
  "description": "Alur ini memungkinkan pengguna memulai penjualan dengan me-reply media atau mengirim media dengan caption /sell. Pengguna kemudian dapat menambahkan lebih banyak media sebelum akhirnya menetapkan harga dan mengonfirmasi penjualan.",
  "phases": [
    {
      "phase_number": 1,
      "phase_name": "Inisiasi Penjualan",
      "trigger": "Pengguna mengirim media dengan caption `/sell` ATAU me-reply media dengan `/sell`.",
      "handler": "`SellCommand.php`",
      "steps": [
        {
          "step": 1.1,
          "name": "Deteksi & Deduplikasi Media Grup",
          "description": "Jika pemicu adalah bagian dari media grup, ID grup dicatat untuk mencegah alur terpicu berulang kali oleh pesan lain dari grup yang sama."
        },
        {
          "step": 1.2,
          "name": "Validasi Prasyarat",
          "description": "Memvalidasi bahwa pengguna adalah penjual terdaftar (jika tidak, memicu sub-alur pendaftaran)."
        },
        {
          "step": 1.3,
          "name": "Pengumpulan Media Awal",
          "description": "Mengumpulkan semua media yang relevan (satu media atau semua media dalam grup) dari database."
        },
        {
          "step": 1.4,
          "name": "Transisi ke State Penjualan",
          "description": "State pengguna diubah menjadi `selling_process` dengan konteks yang berisi daftar media awal. Pengguna kemudian diberi prompt untuk menambahkan lebih banyak media atau menetapkan harga."
        }
      ]
    },
    {
      "phase_number": 2,
      "phase_name": "Proses Penjualan (Stateful)",
      "trigger": "Pengguna (dalam state `selling_process`) mengirim pesan baru.",
      "handler": "`SellingProcessState.php`",
      "scenarios": [
        {
          "scenario_name": "Pengguna Mengirim Media Baru",
          "action": "Media baru ditambahkan ke daftar dalam `state_context`, dan prompt untuk menambah media/harga dikirim ulang."
        },
        {
          "scenario_name": "Pengguna Mengirim Teks (Harga)",
          "action": "Teks divalidasi sebagai harga. Jika valid, harga ditambahkan ke `state_context`, state diubah menjadi `awaiting_sell_confirmation`, dan alur berlanjut ke Fase 3."
        }
      ]
    },
    {
      "phase_number": 3,
      "phase_name": "Konfirmasi Penjualan",
      "trigger": "Setelah harga yang valid dimasukkan pada Fase 2.",
      "handler": "`SellingProcessState.php`",
      "action": "Bot mengirim pesan ringkasan yang berisi jumlah media dan harga, dengan tombol `✅ Konfirmasi & Jual` dan `❌ Batal`. State pengguna sekarang `awaiting_sell_confirmation`."
    },
    {
      "phase_number": 4,
      "phase_name": "Finalisasi Penjualan",
      "trigger": "Pengguna menekan tombol `✅ Konfirmasi & Jual`.",
      "handler": "`SellConfirmCallback.php`",
      "steps": [
        {
          "step": 4.1,
          "name": "Eksekusi Inti (dalam Transaksi)",
          "description": "Mengambil konteks (daftar media & harga) dari state pengguna, lalu membuat paket, menetapkan harga, dan menautkan semua file media ke paket tersebut."
        },
        {
          "step": 4.2,
          "name": "Backup Media",
          "description": "Menyalin semua file media ke channel penyimpanan dan memperbarui lokasinya di database."
        },
        {
          "step": 4.3,
          "name": "Pembersihan & Konfirmasi Akhir",
          "description": "State pengguna direset ke `null`. Pesan konfirmasi diedit menjadi pesan sukses akhir yang berisi ID paket baru."
        }
      ]
    }
  ],
  "sub_flows": [
    {
      "name": "Pembatalan Penjualan",
      "trigger": "Pengguna menekan tombol `❌ Batal` pada pesan konfirmasi.",
      "handler": "`CancelSellCallback.php`",
      "action": "Pesan konfirmasi dihapus dan operasi dibatalkan."
    }
  ]
}